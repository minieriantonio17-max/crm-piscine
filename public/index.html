<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0a0a0a" />
  <title>CRM Piscine — Area Manager</title>
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />
  <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root { --bg:#f6f6f6; --fg:#111; --muted:#6b7280; --brand:#111; --card:#fff; --radius:16px; }
    body { background:var(--bg); color:var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    header { display:flex; justify-content:space-between; align-items:center; padding:16px; }
    .logo { display:grid; place-items:center; width:40px; height:40px; border-radius:14px; background:#111; color:#fff; font-weight:700; }
    h1 { font-size: clamp(18px, 2.5vw, 24px); margin:0 0 4px 0;}
    .sub { color:var(--muted); font-size:12px; }
    .actions button { border:1px solid #ddd; background:#fff; padding:8px 12px; border-radius:12px; cursor:pointer; }
    .tabs { display:flex; gap:8px; flex-wrap:wrap; padding:0 16px 16px; }
    .tab { background:#fff; border:1px solid #e5e7eb; padding:8px 12px; border-radius:12px; cursor:pointer; font-size:14px; }
    .tab.active { background:#111; color:#fff; border-color:#111; }
    .grid { display:grid; gap:16px; grid-template-columns: 1fr; padding: 0 16px 24px; }
    @media(min-width:1000px){ .grid-2 { grid-template-columns: 2fr 1fr; } .grid-3 { grid-template-columns: 2fr 1fr; } }
    .card { background:var(--card); border:1px solid #e5e7eb; border-radius:var(--radius); padding:16px; }
    .kpis { display:grid; grid-template-columns: repeat(5, 1fr); gap:12px; }
    .kpi { border:1px solid #eee; border-radius:14px; padding:12px; display:flex; justify-content:space-between; align-items:center; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { padding:8px; border-bottom:1px solid #eee; text-align:left; }
    .muted { color:var(--muted); font-size:12px; }
    .flex { display:flex; gap:8px; align-items:center; }
    .filters { display:grid; gap:8px; grid-template-columns: 1fr; margin: 0 16px 16px; }
    @media(min-width:900px){ .filters { grid-template-columns: 2fr repeat(3, 1fr) auto; } }
    input, select, textarea { width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:12px; }
    #map { width:100%; height:60vh; border-radius:16px; overflow:hidden; }
    .doc { display:flex; align-items:center; justify-content:space-between; padding:10px; border:1px solid #eee; border-radius:12px; }
    footer.nav { position:fixed; bottom:12px; left:50%; transform:translateX(-50%); background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:6px; display:flex; gap:6px; }
    footer.nav button { padding:8px 10px; border-radius:12px; border:0; background:#f3f4f6; }
    footer.nav button.active { background:#111; color:#fff; }
  </style>
</head>
<body>
  <header>
    <div class="flex">
      <div class="logo">AM</div>
      <div style="margin-left:10px">
        <h1>CRM Piscine — Area Manager</h1>
        <div class="sub">Clienti • Visite • Opportunità • Ordini • Report • Mappa</div>
      </div>
    </div>
    <div class="actions">
      <button id="installBtn" style="display:none;">Installa app</button>
      <button id="btnLoginMs">Connetti Microsoft 365</button>
    </div>
  </header>

  <!-- Filters -->
  <div class="filters">
    <input id="q" placeholder="Cerca cliente..." />
    <select id="fProv"><option value="">Provincia</option></select>
    <select id="fStato"><option value="">Stato</option></select>
    <select id="fTipo"><option value="">Tipo</option></select>
    <button id="reset">Reset</button>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-tab="dashboard">Dashboard</button>
    <button class="tab" data-tab="clienti">Clienti</button>
    <button class="tab" data-tab="visite">Visite</button>
    <button class="tab" data-tab="opps">Opportunità</button>
    <button class="tab" data-tab="ordini">Ordini</button>
    <button class="tab" data-tab="report">Report</button>
    <button class="tab" data-tab="mappa">Mappa</button>
    <button class="tab" data-tab="documenti">Documenti</button>
    <button class="tab" data-tab="import">Import/Export</button>
    <button class="tab" data-tab="outlook">Outlook</button>
  </div>

  <section id="dashboard" class="grid grid-3">
    <div class="card">
      <div class="kpis" id="kpis"></div>
    </div>
    <div class="card">
      <h3>Mix prodotti</h3>
      <canvas id="mixChart" height="220"></canvas>
    </div>
    <div class="card" style="grid-column:1 / -1">
      <h3>Clienti prioritari (gap/target)</h3>
      <table id="topClients"><thead><tr><th>Cliente</th><th>Prov.</th><th>Tipo</th><th>Stato</th><th>Target</th><th>YTD</th><th>Gap</th><th>Ult. visita</th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <section id="clienti" class="grid" style="display:none">
    <div class="card">
      <div class="flex" style="justify-content:space-between"><h3>Anagrafica clienti</h3><button id="btnNewClient">Nuovo cliente</button></div>
      <table id="tblClients"><thead><tr><th>Cliente</th><th>Prov.</th><th>Tipo</th><th>Stato</th><th>Telefono</th><th>Email</th><th>Target</th><th>YTD</th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <section id="visite" class="grid" style="display:none">
    <div class="card">
      <div class="flex" style="justify-content:space-between"><h3>Pianificazione visite</h3><button id="btnNewVisit">Nuova visita</button></div>
      <table id="tblVisits"><thead><tr><th>Data</th><th>Ora</th><th>Cliente</th><th>Provincia</th><th>Obiettivo</th><th>Esito</th></tr></thead><tbody></tbody></table>
      <div class="flex" style="justify-content:flex-end; margin-top:10px">
        <button id="btnExportICS">Esporta agenda (.ics)</button>
        <button id="btnSyncOutlook">Sincronizza su Outlook</button>
      </div>
      <div id="msStatus" class="muted" style="margin-top:6px"></div>
    </div>
  </section>

  <section id="opps" class="grid" style="display:none">
    <div class="card">
      <div class="flex" style="justify-content:space-between"><h3>Pipeline</h3><button id="btnNewOpp">Nuova opportunità</button></div>
      <table id="tblOpps"><thead><tr><th>Nome</th><th>Cliente</th><th>Stadio</th><th>Valore</th><th>Prob.</th><th>Chiusura</th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <section id="ordini" class="grid" style="display:none">
    <div class="card">
      <div class="flex" style="justify-content:space-between"><h3>Ordini & Fatture</h3><button id="btnNewOrder">Nuovo ordine</button></div>
      <table id="tblOrders"><thead><tr><th>#</th><th>Cliente</th><th>Data</th><th>Importo</th><th>Status</th><th>Articoli</th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <section id="report" class="grid" style="display:none">
    <div class="card">
      <h3>Andamento vs Target</h3>
      <canvas id="trendChart" height="260"></canvas>
    </div>
    <div class="card">
      <h3>Indicatori chiave</h3>
      <ul id="indicators" class="muted"></ul>
    </div>
  </section>

  <section id="mappa" class="grid" style="display:none">
    <div class="card">
      <div id="map"></div>
      <div class="muted" style="margin-top:6px">La mappa rispetta i filtri (provincia, stato, tipo, ricerca).</div>
    </div>
  </section>

  <section id="documenti" class="grid" style="display:none">
    <div class="card">
      <h3>Libreria documenti (OneDrive)</h3>
      <p class="muted">Carica report settimanali, offerte, preventivi. Upload su OneDrive via Graph al prossimo step.</p>
      <input type="file" id="docInput" multiple />
      <div id="docList" style="margin-top:10px; display:grid; gap:8px"></div>
    </div>
  </section>

  <section id="import" class="grid" style="display:none">
    <div class="card">
      <h3>Esporta</h3>
      <div class="flex"><button id="btnExportClients">Clienti CSV</button><button id="btnExportOrders">Ordini CSV</button></div>
      <h3 style="margin-top:16px">Power BI (Push dataset)</h3>
      <input id="powerBiUrl" placeholder="(Facoltativo) incolla qui l'URL REST del dataset, oppure usa il proxy /api/powerbi-push con ENV" />
      <div class="flex" style="gap:8px; margin-top:6px">
        <button id="btnPushPbiClient">Invia direttamente (client)</button>
        <button id="btnPushPbiServer">Invia via serverless (/api/powerbi-push)</button>
      </div>
      <div id="pbiMsg" class="muted" style="margin-top:6px"></div>
      <h3 style="margin-top:16px">Importa CSV</h3>
      <input type="file" id="csvInput" accept=".csv" />
    </div>
  </section>

  <section id="outlook" class="grid" style="display:none">
    <div class="card">
      <h3>Collegamento Outlook / Microsoft 365</h3>
      <div class="flex" style="gap:12px">
        <button id="btnExportICS2">Esporta agenda (.ics)</button>
        <button id="btnLoginMs2">Login Microsoft</button>
      </div>
      <div class="muted" style="margin-top:10px">
        Dopo il login, il pulsante "Sincronizza su Outlook" nella sezione <b>Visite</b> creerà gli eventi nel calendario (<code>/me/events</code>).
        Scopi richiesti: <code>User.Read</code>, <code>Calendars.ReadWrite</code>.
      </div>
    </div>
  </section>

  <footer class="nav">
    <button class="active" data-tab="dashboard">Home</button>
    <button data-tab="clienti">Clienti</button>
    <button data-tab="visite">Visite</button>
    <button data-tab="report">Report</button>
    <button data-tab="mappa">Mappa</button>
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@3.10.0/lib/msal-browser.min.js"></script>
  <script>
  // Config MSAL (metti il tuo client ID e redirect)
  const MSAL_CONFIG = {
    clientId: "INSERISCI_CLIENT_ID_AZURE_AD",
    redirectUri: window.location.origin, // es: https://crm-piscine.vercel.app
    cache: { cacheLocation: "localStorage", storeAuthStateInCookie: false },
    auth: { clientId: "INSERISCI_CLIENT_ID_AZURE_AD", redirectUri: window.location.origin }
  };
  const MS_SCOPES = ["User.Read", "Calendars.ReadWrite", "offline_access", "openid", "profile", "email"];
  let msalInstance = null;
  let graphToken = null;

  async function msLogin(){
    try{
      if(!msalInstance){
        msalInstance = new msal.PublicClientApplication({ auth: MSAL_CONFIG.auth, cache: MSAL_CONFIG.cache });
      }
      const accounts = msalInstance.getAllAccounts();
      if(accounts.length){
        const r = await msalInstance.acquireTokenSilent({ scopes: MS_SCOPES, account: accounts[0] });
        graphToken = r.accessToken; return accounts[0];
      }else{
        const r = await msalInstance.loginPopup({ scopes: MS_SCOPES });
        const t = await msalInstance.acquireTokenSilent({ scopes: MS_SCOPES, account: r.account });
        graphToken = t.accessToken; return r.account;
      }
    }catch(e){ document.getElementById('msStatus').textContent = "Login MS: "+e.message; throw e; }
  }

  async function graph(path, method="GET", body){
    if(!graphToken) await msLogin();
    const r = await fetch("https://graph.microsoft.com/v1.0"+path, {
      method, headers: { "Authorization":"Bearer "+graphToken, "Content-Type":"application/json" },
      body: body? JSON.stringify(body): undefined
    });
    if(!r.ok){ const text = await r.text(); throw new Error(text); }
    return r.json();
  }

  // --- Data (persist in localStorage) ---
  const PROVINCE = ["MI","CR","PV","LO","MN","RE","FE","BO","NO","VB","SP","SV","CO","BG","BS","LC","VA","PI","GE","IM"];
  const STATUS = ["Attivo","Prospect","Dormiente","A Rischio"];
  const CLIENT_TYPES = ["Costruttore","Manutentore","Showroom","Distributore"];
  const MONTHS = ["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"];
  const LS = {
    get: (k, fallback)=> { try{ return JSON.parse(localStorage.getItem(k) || JSON.stringify(fallback)); }catch(_){ return fallback; } },
    set: (k, v)=> localStorage.setItem(k, JSON.stringify(v))
  };
  let clients = LS.get("clients", [
    { id:1, name:"Kovacic Piscine", province:"RE", type:"Costruttore", status:"Attivo", phone:"+39 0522 123456", email:"info@kovacic.it", annualTarget:80000, ytd:52000, lastVisit:"2025-07-19", lat:44.6979, lng:10.6313 },
    { id:2, name:"Bologna Piscine", province:"BO", type:"Costruttore", status:"Prospect", phone:"+39 051 654321", email:"ordini@bolognapiscine.it", annualTarget:60000, ytd:12000, lastVisit:"2025-07-15", lat:44.4949, lng:11.3426 },
    { id:3, name:"Verdeazzurro", province:"CR", type:"Manutentore", status:"Attivo", phone:"+39 0372 998877", email:"acquisti@verdeazzurro.it", annualTarget:45000, ytd:41000, lastVisit:"2025-07-12", lat:45.1333, lng:10.0227 },
    { id:4, name:"Arte Piscina", province:"PV", type:"Showroom", status:"A Rischio", phone:"+39 0382 443322", email:"arte@piscina.it", annualTarget:30000, ytd:8000, lastVisit:"2025-06-28", lat:45.1850, lng:9.1582 },
  ]);
  let visits = LS.get("visits", [
    { id:1, clientId:1, date:"2025-08-11", time:"10:30", objective:"Presentare centralina Evo e promo Hanscraft", outcome:"", province:"RE", owner:"Tu" },
    { id:2, clientId:2, date:"2025-08-12", time:"15:00", objective:"Mappatura bisogni pre-stagionali", outcome:"", province:"BO", owner:"Tu" },
    { id:3, clientId:3, date:"2025-08-13", time:"09:00", objective:"Allineamento assistenza e upsell pompe VS", outcome:"", province:"CR", owner:"Tu" },
  ]);
  let opps = LS.get("opps", [
    { id:1, clientId:1, name:"Commessa 12 ville zona Parma", stage:"Qualifica", value:42000, probability:0.4, closeDate:"2025-09-20" },
    { id:2, clientId:2, name:"Nuovo showroom BO - impianti 2026", stage:"Proposta", value:65000, probability:0.35, closeDate:"2025-11-30" },
    { id:3, clientId:4, name:"Sostituzione 10 pompe di calore", stage:"Negoziazione", value:28000, probability:0.6, closeDate:"2025-10-05" },
  ]);
  let orders = LS.get("orders", [
    { id:1001, clientId:1, date:"2025-07-29", amount:8200, status:"Confermato", items:[{sku:"EVO-CTRL", qty:2},{sku:"HCRAFT-SPA", qty:1}] },
    { id:1002, clientId:3, date:"2025-07-25", amount:4100, status:"Fatturato", items:[{sku:"PUMP-VS50", qty:1},{sku:"SALT-PRO", qty:1}] },
    { id:1003, clientId:4, date:"2025-07-20", amount:2600, status:"In attesa", items:[{sku:"ROBOT-BATT", qty:2}] },
  ]);
  const clientById = id => clients.find(c=>c.id===id);
  const saveAll = ()=> { LS.set("clients", clients); LS.set("visits", visits); LS.set("opps", opps); LS.set("orders", orders); }

  // Filters
  const q = document.getElementById('q');
  const fProv = document.getElementById('fProv');
  const fStato = document.getElementById('fStato');
  const fTipo = document.getElementById('fTipo');
  PROVINCE.forEach(p=> fProv.append(new Option(p,p)));
  STATUS.forEach(s=> fStato.append(new Option(s,s)));
  CLIENT_TYPES.forEach(t=> fTipo.append(new Option(t,t)));
  document.getElementById('reset').onclick = ()=>{ q.value=''; fProv.value=''; fStato.value=''; fTipo.value=''; renderAll(); };
  function filteredClients(){
    return clients.filter(c=>
      (!q.value || c.name.toLowerCase().includes(q.value.toLowerCase())) &&
      (!fProv.value || c.province===fProv.value) &&
      (!fStato.value || c.status===fStato.value) &&
      (!fTipo.value || c.type===fTipo.value)
    );
  }

  // KPI / charts
  const currency = n => n.toLocaleString('it-IT',{style:'currency',currency:'EUR'});
  function kpi(){
    const ytd = clients.reduce((s,c)=> s+c.ytd, 0);
    const target = clients.reduce((s,c)=> s+c.annualTarget, 0);
    const gap = target - ytd;
    const pipelineWeighted = opps.reduce((s,o)=> s + o.value * o.probability, 0);
    const monthIdx = new Date().getMonth();
    const runRate = monthIdx>=0 ? (ytd/(monthIdx+1)) : 0;
    const projection = runRate * 12;
    const forecast = Math.max(ytd + pipelineWeighted, projection);
    return { ytd, target, gap, pipelineWeighted, forecast };
  }
  function renderKpi(){
    const {ytd,target,gap,pipelineWeighted,forecast} = kpi();
    const el = document.getElementById('kpis');
    el.innerHTML = [
      ['YTD Fatturato', currency(ytd)],
      ['Target Annuale', currency(target)],
      ['Gap', currency(gap)],
      ['Pipeline Ponderata', currency(pipelineWeighted)],
      ['Forecast fine anno', currency(forecast)]
    ].map(([l,v])=> `<div class="kpi"><div><div class="muted">${l}</div><div style="font-weight:700">${v}</div></div></div>`).join('');
  }

  let mixChart, trendChart;
  function renderCharts(){
    const ctx1 = document.getElementById('mixChart');
    const mix = { labels:['Pompe di calore','Pompe VS','Centraline','Pulitori','Accessori'], data:[38,22,16,12,12] };
    if(mixChart) mixChart.destroy();
    mixChart = new Chart(ctx1, { type:'doughnut', data:{ labels:mix.labels, datasets:[{ data: mix.data }] }, options:{ responsive:true } });

    const ctx2 = document.getElementById('trendChart');
    const names = clients.map(c=> c.name);
    const targets = clients.map(c=> c.annualTarget);
    const ytds = clients.map(c=> c.ytd);
    if(trendChart) trendChart.destroy();
    trendChart = new Chart(ctx2, { type:'line', data:{ labels:names, datasets:[{label:'Target', data:targets}, {label:'YTD', data:ytds}] }, options:{ responsive:true } });
  }

  function renderTopClients(){
    const tb = document.querySelector('#topClients tbody');
    const rows = [...clients].sort((a,b)=>(b.annualTarget-b.ytd)-(a.annualTarget-a.ytd)).slice(0,6).map(c=> `
      <tr><td>${c.name}</td><td>${c.province}</td><td>${c.type}</td><td>${c.status}</td>
      <td>${currency(c.annualTarget)}</td><td>${currency(c.ytd)}</td><td>${currency(c.annualTarget-c.ytd)}</td><td>${c.lastVisit}</td></tr>`).join('');
    tb.innerHTML = rows;
  }

  // Tables
  function renderClientsTable(){
    const tb = document.querySelector('#tblClients tbody');
    tb.innerHTML = filteredClients().map(c=> `<tr>
      <td>${c.name}</td><td>${c.province}</td><td>${c.type}</td><td>${c.status}</td>
      <td>${c.phone}</td><td>${c.email}</td><td>${currency(c.annualTarget)}</td><td>${currency(c.ytd)}</td>
    </tr>`).join('');
  }
  function renderVisitsTable(){
    const tb = document.querySelector('#tblVisits tbody');
    tb.innerHTML = [...visits].sort((a,b)=> a.date.localeCompare(b.date)).map(v=> `<tr>
      <td>${v.date}</td><td>${v.time}</td><td>${clientById(v.clientId)?.name||'-'}</td>
      <td>${v.province}</td><td>${v.objective}</td><td>${v.outcome||'—'}</td>
    </tr>`).join('');
  }
  function renderOppsTable(){
    const tb = document.querySelector('#tblOpps tbody');
    tb.innerHTML = opps.map(o=> `<tr>
      <td>${o.name}</td><td>${clientById(o.clientId)?.name||'-'}</td><td>${o.stage}</td>
      <td>${currency(o.value)}</td><td>${Math.round(o.probability*100)}%</td><td>${o.closeDate}</td>
    </tr>`).join('');
  }
  function renderOrdersTable(){
    const tb = document.querySelector('#tblOrders tbody');
    tb.innerHTML = orders.map(o=> `<tr>
      <td>${o.id}</td><td>${clientById(o.clientId)?.name||'-'}</td><td>${o.date}</td>
      <td>${currency(o.amount)}</td><td>${o.status}</td><td>${o.items.map(it=> it.sku+' x'+it.qty).join(', ')}</td>
    </tr>`).join('');
  }

  // Map
  let map, markersLayer;
  function renderMap(){
    const data = filteredClients().filter(c=> typeof c.lat==='number' && typeof c.lng==='number');
    const avgLat = data.reduce((s,c)=> s+c.lat, 0)/data.length || 43.77;
    const avgLng = data.reduce((s,c)=> s+c.lng, 0)/data.length || 11.24;
    if(!map){
      map = L.map('map').setView([avgLat, avgLng], 7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
    }
    markersLayer.clearLayers();
    data.forEach(c=>{
      const m = L.marker([c.lat, c.lng]).bindPopup(`
        <b>${c.name}</b><br/>
        Prov. ${c.province} • ${c.type} • ${c.status}<br/>
        ${c.phone} · ${c.email}<br/>
        Target ${currency(c.annualTarget)} — YTD ${currency(c.ytd)}<br/>
        Ult. visita: ${c.lastVisit||'—'}
      `);
      markersLayer.addLayer(m);
    });
  }

  // CSV / ICS / PBI
  function download(name, content, type='text/plain'){
    const blob = new Blob([content], {type}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }
  function toCSV(rows, headers){
    const esc = v => '\"' + String(v??'').replace(/\"/g,'\"\"') + '\"';
    return [headers.join(',')].concat(rows.map(r=> headers.map(h=> esc(r[h])).join(','))).join('\n');
  }
  function exportClientsCSV(){
    const headers = ['id','name','province','type','status','phone','email','annualTarget','ytd','lastVisit','lat','lng'];
    download('clienti.csv', toCSV(clients, headers), 'text/csv');
  }
  function exportOrdersCSV(){
    const flat = orders.map(o=> ({ id:o.id, client: clientById(o.clientId)?.name, date:o.date, amount:o.amount, status:o.status, items:o.items.map(it=> `${it.sku} x${it.qty}`).join('|') }));
    const headers = ['id','client','date','amount','status','items'];
    download('ordini.csv', toCSV(flat, headers), 'text/csv');
  }
  function toICS(events){
    const lines = ['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//CRM Piscine//IT','CALSCALE:GREGORIAN'];
    events.forEach(e=>{
      const fmt = s => s.replace(/[-:]/g,'').replace('.000Z','Z');
      lines.push('BEGIN:VEVENT');
      lines.push('UID:'+e.uid);
      lines.push('DTSTART:'+fmt(new Date(e.dtstart).toISOString()));
      if(e.dtend) lines.push('DTEND:'+fmt(new Date(e.dtend).toISOString()));
      lines.push('SUMMARY:'+e.summary);
      if(e.location) lines.push('LOCATION:'+e.location);
      if(e.description) lines.push('DESCRIPTION:'+e.description.replace(/\\n/g,'\\\\n'));
      lines.push('END:VEVENT');
    });
    lines.push('END:VCALENDAR');
    return lines.join('\\n');
  }
  function exportICS(){
    const events = visits.map(v=> ({ dtstart:`${v.date}T${v.time}:00`, dtend:`${v.date}T${v.time}:00`, summary:`Visita • ${clientById(v.clientId)?.name || 'Cliente'}`, description:v.objective||'', location:v.province||'', uid:String(v.id) }));
    download('agenda_visite.ics', toICS(events), 'text/calendar');
  }
  async function pushToPowerBIClient(){
    const url = document.getElementById('powerBiUrl').value.trim();
    const msg = document.getElementById('pbiMsg');
    if(!url){ msg.textContent = 'Inserisci URL push dataset Power BI oppure usa il tasto serverless.'; return; }
    msg.textContent = 'Invio (client) in corso...';
    try{
      const payload = { rows: clients.map(c=> ({ id:c.id, name:c.name, province:c.province, type:c.type, status:c.status, annualTarget:c.annualTarget, ytd:c.ytd })) };
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if(!res.ok) throw new Error('HTTP '+res.status);
      msg.textContent = '✅ Dati inviati a Power BI (client)';
    }catch(e){ msg.textContent = '❌ Errore: '+e.message+' (CORS probabili)'; }
  }
  async function pushToPowerBIServer(){
    const msg = document.getElementById('pbiMsg');
    msg.textContent = 'Invio (serverless) in corso...';
    try{
      const payload = { rows: clients.map(c=> ({ id:c.id, name:c.name, province:c.province, type:c.type, status:c.status, annualTarget:c.annualTarget, ytd:c.ytd })) };
      const res = await fetch('/api/powerbi-push', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const text = await res.text();
      if(!res.ok) throw new Error(text || ('HTTP '+res.status));
      msg.textContent = '✅ Dati inviati a Power BI (serverless)';
    }catch(e){ msg.textContent = '❌ Errore: '+e.message+' (controlla PBI_PUSH_URL in Vercel)'; }
  }

  // Outlook sync (Graph)
  async function syncVisitsToOutlook(){
    const status = document.getElementById('msStatus'); status.textContent = 'Login Microsoft…';
    try{
      await msLogin();
      status.textContent = 'Creo eventi…';
      for(const v of visits){
        const startIso = v.date+'T'+v.time+':00';
        const endIso = v.date+'T'+v.time+':00';
        const body = {
          subject: 'Visita • '+(clientById(v.clientId)?.name || 'Cliente'),
          body: { contentType:'HTML', content: (v.objective||'') },
          start: { dateTime: startIso, timeZone: 'Europe/Rome' },
          end: { dateTime: endIso, timeZone: 'Europe/Rome' },
          location: { displayName: v.province||'' }
        };
        await graph('/me/events', 'POST', body);
      }
      status.textContent = '✅ Visite sincronizzate sul calendario Outlook';
    }catch(e){
      status.textContent = '❌ Errore sync: '+e.message;
    }
  }

  // Documents
  const docInput = document.getElementById('docInput');
  const docList = document.getElementById('docList');
  docInput?.addEventListener('change', async (e)=>{
    const files = Array.from(e.target.files||[]);
    for (const f of files){
      const buf = await f.arrayBuffer();
      const blob = new Blob([buf], {type: f.type||'application/octet-stream'});
      const row = document.createElement('div');
      row.className = 'doc';
      const when = new Date().toLocaleString();
      row.innerHTML = `<div><div style="font-weight:600">${f.name}</div><div class="muted">${f.type||'file'} • ${when}</div></div>`;
      const btn = document.createElement('button'); btn.textContent='Scarica'; btn.onclick = ()=> download(f.name, blob, f.type);
      row.append(btn);
      docList.append(row);
    }
    e.target.value = '';
  });

  // Tabs + bottom nav
  const tabs = Array.from(document.querySelectorAll('.tab'));
  const sections = ['dashboard','clienti','visite','opps','ordini','report','mappa','documenti','import','outlook'];
  function showTab(name){
    sections.forEach(id=> document.getElementById(id).style.display = (id===name?'grid':'none'));
    tabs.forEach(t=> t.classList.toggle('active', t.dataset.tab===name));
    document.querySelectorAll('footer.nav button').forEach(b=> b.classList.toggle('active', b.dataset.tab===name));
    if(name==='mappa'){ setTimeout(renderMap, 50); }
    if(name==='report'){ setTimeout(renderCharts, 50); }
  }
  tabs.forEach(t=> t.onclick = ()=> showTab(t.dataset.tab));
  document.querySelectorAll('footer.nav button').forEach(b=> b.onclick = ()=> showTab(b.dataset.tab));

  // Install prompt
  let deferred; window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferred=e; document.getElementById('installBtn').style.display='inline-block'; });
  document.getElementById('installBtn').onclick = async ()=> deferred?.prompt();

  // Export buttons + Outlook buttons
  document.getElementById('btnExportClients').onclick = exportClientsCSV;
  document.getElementById('btnExportOrders').onclick = exportOrdersCSV;
  document.getElementById('btnExportICS').onclick = exportICS;
  document.getElementById('btnExportICS2').onclick = exportICS;
  document.getElementById('btnPushPbiClient').onclick = pushToPowerBIClient;
  document.getElementById('btnPushPbiServer').onclick = pushToPowerBIServer;
  document.getElementById('btnSyncOutlook').onclick = syncVisitsToOutlook;
  document.getElementById('btnLoginMs').onclick = msLogin;
  document.getElementById('btnLoginMs2').onclick = msLogin;

  // Render all
  function renderAll(){
    renderKpi(); renderTopClients(); renderClientsTable(); renderVisitsTable(); renderOppsTable(); renderOrdersTable(); renderMap(); renderCharts();
  }
  q.oninput = fProv.onchange = fStato.onchange = fTipo.onchange = renderAll;

  if('serviceWorker' in navigator){ navigator.serviceWorker.register('/service-worker.js'); }
  renderAll();
  </script>
</body>
</html>
